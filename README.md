# 競馬予測モデル学習スクリプト 改善版

## 📋 概要

LightGBM Rankerを使用した競馬予測モデルの学習スクリプトです。
元のコードから以下の点を大幅に改善しました。

## ✨ 主な改善点

### 🛡️ v2.0 - 堅牢性の大幅強化（最新版）

**カラム不足に完全対応：**
- すべての特徴量関数に必須カラムチェックを実装
- カラムが無い場合は自動スキップ（エラーで止まらない）
- 詳細なエラーメッセージで問題箇所を特定可能

**防御的プログラミング：**
- `distance`カラムが無くてもスピード特徴量をスキップして続行
- `passing`カラムが無くても通過順特徴量をスキップして続行
- 各関数が独立して動作し、一部の失敗が全体に影響しない

**詳細なログ出力：**
```
✓ 通過順特徴量 を追加中...
⚠️  スピード特徴量: 必須カラムが不足 ['distance'] - スキップ
✓ 近走差分特徴量 を追加中...
   ✓ 12個の数値カラムに近走差分を追加
```

### 1. **エラーハンドリングの強化**
- ファイルが見つからない場合の詳細なエラーメッセージ
- 各処理でのtry-except処理
- データ欠損時の適切な警告表示
- **NEW!** 必須カラムの自動チェック

### 2. **データ分割の実装**
- **日付ベースの分割**：時系列を考慮した訓練/検証データ分割
- 未来のデータで評価することで、より実践的な性能評価が可能
- 日付がない場合のフォールバック処理

### 3. **評価指標の追加**
- 検証データでのモデル性能評価
- Top3的中率の計算
- レース単位での詳細な分析

### 4. **設定管理の改善**
- `Config`クラスで設定を一元管理
- パラメータ調整が容易
- YAML設定ファイルへの拡張も可能

### 5. **ロギングの充実**
- 各処理段階での進捗表示
- 絵文字を使った視覚的に分かりやすい出力
- 処理時間の計測

### 6. **メモリ管理の最適化**
- 不要なデータフレームの削除
- ガベージコレクションの明示的な実行
- 大規模データへの対応

### 7. **Early Stoppingの実装**
- 過学習の防止
- 学習時間の短縮
- 最適な反復回数の自動決定

### 8. **出力ファイルの充実**
```
outputs/
├── horse_racing_lgbm_ranker.txt  # 学習済みモデル
├── feature_list.pkl               # 特徴量リスト
├── feature_importance.csv         # 特徴量重要度
└── training_metrics.csv           # 評価指標
```

## 🚀 使用方法

### 基本的な実行

```bash
python train_lgbm_ranker_improved.py
```

### 前提条件

1. **ディレクトリ構成**
```
project/
├── data/                          # 学習データ（CSVファイル）
│   ├── race_2023.csv
│   ├── race_2024.csv
│   └── ...
├── jockey_profile.csv             # 騎手プロファイル（オプション）
├── train_lgbm_ranker_improved.py  # メインスクリプト
├── feature_engineering.py
├── add_passing_features.py
├── add_jockey_style_features.py
├── add_speed_features.py
├── add_distance_preference_features.py
└── add_recent_diff_features.py
```

2. **必要なライブラリ**
```bash
pip install pandas numpy lightgbm scikit-learn joblib
```

### データの準備

CSVファイルには最低限以下のカラムが必要です：

**必須カラム：**
- `race_id`: レースID
- `horse_name`: 馬名
- `rank`: 着順（数値）

**推奨カラム（より高精度な予測のため）：**
- `race_date`: レース日付（YYYY-MM-DD形式）
- `distance`: 距離（メートル）
- `time`: タイム（例: "1:23.4"）
- `passing`: 通過順（例: "1-1-1-1"）
- `age_sex`: 年齢性別（例: "5牡"）
- `horse_weight`: 馬体重（例: "480(+2)"）
- `jockey`: 騎手名

**💡 カラムが不足している場合:**
- 心配不要！不足している特徴量は自動的にスキップされます
- ただし、精度向上のため推奨カラムを揃えることをおすすめします
- 詳しくは [TROUBLESHOOTING.md](TROUBLESHOOTING.md) を参照

## ⚙️ カスタマイズ

### 設定の変更

`train_lgbm_ranker_improved.py`の`Config`クラスで以下を調整できます：

```python
class Config:
    # データ分割日（この日付までが訓練データ）
    TRAIN_END_DATE = "2024-06-30"
    
    # LightGBMパラメータ
    LGBM_PARAMS = {
        "num_leaves": 31,        # ツリーの複雑さ
        "learning_rate": 0.05,   # 学習率
        "n_estimators": 800,     # 最大反復回数
        # ...
    }
```

### 除外カラムの追加

人気以外にも除外したいカラムがある場合：

```python
IGNORE_COLS = [
    # 既存のカラム...
    "your_custom_column",  # 追加
]
```

## 📊 出力の見方

### 1. コンソール出力例

```
🏇 競馬予測モデル学習スクリプト
============================================================
📂 CSVファイルを読み込んでいます...
   見つかったファイル: 2個
   - race_2023.csv
   - race_2024.csv
✅ 読み込み完了: 50,000 行

🔧 基本前処理を実行中...
   無効な順位データを除去: 123 行
✅ 基本前処理完了: 49,877 行

🎯 特徴量生成を実行中...
   ✓ 通過順特徴量 を追加中...
   ✓ 騎手傾向特徴量 を追加中...
   ✓ スピード特徴量 を追加中...
   ✓ 距離適性特徴量 を追加中...
   ✓ 近走差分特徴量 を追加中...
✅ 特徴量生成完了

📊 データセットを構築中...
   特徴量数: 45
   訓練データ: 35,000 行 (～2024-06-30)
   検証データ: 14,877 行 (2024-06-30～)

🚀 モデル学習を開始...
   訓練レース数: 3,500
   検証レース数: 1,487
[100]	valid_0's ndcg@1: 0.345
[200]	valid_0's ndcg@1: 0.378
...
✅ 学習完了 (所要時間: 45.3秒)

📈 モデル評価中...
   検証レース数: 1,487
   Top3的中率: 67.23%
   平均的中頭数: 1.89

💾 モデルと結果を保存中...
   ✓ モデル: outputs/horse_racing_lgbm_ranker.txt
   ✓ 特徴量リスト: outputs/feature_list.pkl
   ✓ 特徴量重要度: outputs/feature_importance.csv
   ✓ 評価指標: outputs/training_metrics.csv

📊 特徴量重要度 (Top 20)
------------------------------------------------------------
   speed_recent_diff_3                              2453.2
   passing_gain                                     1876.5
   speed_dist_diff                                  1654.8
   ...
```

### 2. 特徴量重要度 (feature_importance.csv)

モデルがどの特徴量を重視しているかを確認できます。
重要度が高い特徴量ほど予測に大きく貢献しています。

### 3. 評価指標 (training_metrics.csv)

各レースでの予測精度を確認できます。

## 🎯 あなたのコーディングスタイル分析

アップロードされたコードから、あなたの思考スタイルが見えてきました：

### 観察されたパターン

1. **モジュール分離** 
   - 各機能を独立したファイルに分離
   - 責任の明確な分担

2. **段階的な処理**
   - 基本前処理 → 高度な特徴量生成の順序
   - 各ステップが独立している

3. **データ中心**
   - DataFrameを主軸とした処理フロー
   - パイプライン的な変換

### おすすめのパラダイム

あなたには **関数型プログラミング + オブジェクト指向** のハイブリッドが合いそうです：

- ✅ **関数型的側面**：データ変換のパイプライン、純粋関数
- ✅ **オブジェクト指向的側面**：設定やモデルの状態管理
- ✅ **手続き型的側面**：段階的な処理フロー

今回の改善版では：
- 関数を小さく分割（関数型）
- Configクラスで状態管理（OOP）
- mainで明確なフロー（手続き型）

という形で、あなたの自然な思考スタイルを活かしています。

## 💡 次のステップ

1. **ハイパーパラメータチューニング**
   - Optunaなどを使った自動最適化

2. **アンサンブル**
   - 複数モデルの予測を組み合わせ

3. **特徴量エンジニアリング**
   - 新しい特徴量の追加
   - 相互作用項の検討

4. **推論スクリプト**
   - 新しいレースデータでの予測実行

## 📝 ライセンス

オリジナルコードの著作権は作成者に帰属します。

## 🤝 サポート

問題が発生した場合は、エラーメッセージと共にご相談ください。
