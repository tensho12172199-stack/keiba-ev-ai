# ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

## ğŸš¨ ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•

### âŒ ã‚¨ãƒ©ãƒ¼: ç‰¹å¾´é‡ç”Ÿæˆã«å¤±æ•— - 'distance'

```
âš ï¸  ã‚¹ãƒ”ãƒ¼ãƒ‰ç‰¹å¾´é‡ ã®ç”Ÿæˆã«å¤±æ•—: 'distance'
âš ï¸  è·é›¢é©æ€§ç‰¹å¾´é‡ ã®ç”Ÿæˆã«å¤±æ•—: 'distance'
```

**åŸå› ï¼š**
- CSVãƒ•ã‚¡ã‚¤ãƒ«ã«`distance`ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„
- ã‚«ãƒ©ãƒ åãŒç•°ãªã‚‹ï¼ˆä¾‹: `kyori`, `race_distance`ãªã©ï¼‰

**è§£æ±ºæ–¹æ³•ï¼š**

#### 1ï¸âƒ£ ã‚«ãƒ©ãƒ åã‚’ç¢ºèª
```python
import pandas as pd
df = pd.read_csv("data/your_file.csv")
print(df.columns.tolist())
```

#### 2ï¸âƒ£ ã‚«ãƒ©ãƒ åã‚’ä¿®æ­£
CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ç¢ºèªï¼š

**å¿…é ˆã‚«ãƒ©ãƒ ï¼š**
- `distance` - ãƒ¬ãƒ¼ã‚¹è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
- `time` - ã‚¿ã‚¤ãƒ ï¼ˆä¾‹: "1:23.4"ï¼‰
- `passing` - é€šéé †ï¼ˆä¾‹: "1-2-3-4"ï¼‰
- `race_id` - ãƒ¬ãƒ¼ã‚¹ID
- `horse_name` - é¦¬å
- `rank` - ç€é †

**æ¨å¥¨ã‚«ãƒ©ãƒ ï¼š**
- `race_date` - ãƒ¬ãƒ¼ã‚¹æ—¥ä»˜
- `jockey` - é¨æ‰‹å
- `age_sex` - å¹´é½¢æ€§åˆ¥ï¼ˆä¾‹: "5ç‰¡"ï¼‰
- `horse_weight` - é¦¬ä½“é‡ï¼ˆä¾‹: "480(+2)"ï¼‰

#### 3ï¸âƒ£ ã‚«ãƒ©ãƒ åãŒé•ã†å ´åˆã®å¯¾å¿œ

ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ©ãƒ åã‚’å¤‰æ›´ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼š

```python
# rename_columns.py
import pandas as pd

# CSVã‚’èª­ã¿è¾¼ã¿
df = pd.read_csv("data/your_file.csv")

# ã‚«ãƒ©ãƒ åã‚’å¤‰æ›´
column_mapping = {
    "kyori": "distance",        # è·é›¢
    "time_result": "time",      # ã‚¿ã‚¤ãƒ 
    "tsuka_jun": "passing",     # é€šéé †
    "umaban": "horse_number",   # é¦¬ç•ª
    # å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
}

df = df.rename(columns=column_mapping)

# ä¿å­˜
df.to_csv("data/your_file_fixed.csv", index=False)
print("âœ… ã‚«ãƒ©ãƒ åã‚’ä¿®æ­£ã—ã¾ã—ãŸ")
```

---

### âŒ ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„

```
âš ï¸  é€šéé †ç‰¹å¾´é‡: passingã‚«ãƒ©ãƒ ãŒä¸è¶³
```

**åŸå› ï¼š**
- å¿…é ˆã‚«ãƒ©ãƒ ãŒæ¬ ã‘ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
æ¬ ã‘ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: è©²å½“ã™ã‚‹ç‰¹å¾´é‡ã‚’ã‚¹ã‚­ãƒƒãƒ—
ãã®ã¾ã¾å®Ÿè¡Œã‚’ç¶šã‘ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚
ï¼ˆè©²å½“ã™ã‚‹ç‰¹å¾´é‡ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ãŒã€å­¦ç¿’ã¯å¯èƒ½ï¼‰

---

### âŒ ã‚¨ãƒ©ãƒ¼: æ—¥ä»˜ã®å¤‰æ›ã«å¤±æ•—

```
âš ï¸  æ—¥ä»˜ãŒç„¡åŠ¹: 5000 è¡Œ
```

**åŸå› ï¼š**
- `race_date`ã®å½¢å¼ãŒä¸æ­£ï¼ˆä¾‹: "2024/01/15" â†’ "2024-01-15"ãŒæ­£ã—ã„ï¼‰

**è§£æ±ºæ–¹æ³•ï¼š**

```python
# fix_dates.py
import pandas as pd

df = pd.read_csv("data/your_file.csv")

# æ—¥ä»˜å½¢å¼ã‚’ä¿®æ­£
df["race_date"] = pd.to_datetime(df["race_date"], format="%Y/%m/%d").dt.strftime("%Y-%m-%d")

df.to_csv("data/your_file_fixed.csv", index=False)
```

---

### âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¢ãƒªä¸è¶³

```
MemoryError: Unable to allocate...
```

**è§£æ±ºæ–¹æ³•ï¼š**

#### 1ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã—ã¦å‡¦ç†

```python
# ãƒ‡ãƒ¼ã‚¿ã‚’å¹´ã”ã¨ã«åˆ†ã‘ã¦å­¦ç¿’
import pandas as pd

# 2023å¹´ã®ã¿ã§å­¦ç¿’
df = pd.read_csv("data/race_2023.csv")
# å­¦ç¿’å®Ÿè¡Œ...
```

#### 2ï¸âƒ£ ä¸è¦ãªç‰¹å¾´é‡ã‚’å‰Šé™¤

`train_lgbm_ranker_improved.py`ã§ï¼š

```python
# è¿‘èµ°å·®åˆ†ç‰¹å¾´é‡ã‚’ç„¡åŠ¹åŒ–ï¼ˆå¤§é‡ã®ç‰¹å¾´é‡ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰
feature_funcs = [
    ("é€šéé †ç‰¹å¾´é‡", add_passing_features, ["passing"]),
    ("é¨æ‰‹å‚¾å‘ç‰¹å¾´é‡", lambda x: add_jockey_style_features(x, "jockey_profile.csv"), []),
    ("ã‚¹ãƒ”ãƒ¼ãƒ‰ç‰¹å¾´é‡", add_speed_features, ["distance", "time_sec"]),
    ("è·é›¢é©æ€§ç‰¹å¾´é‡", add_distance_preference_features, ["distance", "speed"]),
    # ("è¿‘èµ°å·®åˆ†ç‰¹å¾´é‡", lambda x: add_recent_diff_features(x, n_recent=3), []),  # â† ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
]
```

#### 3ï¸âƒ£ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è»½é‡åŒ–

```python
LGBM_PARAMS = {
    "num_leaves": 15,      # 31 â†’ 15 ã«å‰Šæ¸›
    "n_estimators": 400,   # 800 â†’ 400 ã«å‰Šæ¸›
    # ...
}
```

---

### âŒ ã‚¨ãƒ©ãƒ¼: CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„

```
âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
   data ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```

**è§£æ±ºæ–¹æ³•ï¼š**

#### 1ï¸âƒ£ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’ç¢ºèª

```
your_project/
â”œâ”€â”€ data/              â† ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
â”‚   â””â”€â”€ race.csv       â† CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
â”œâ”€â”€ train_lgbm_ranker_improved.py
â””â”€â”€ ...
```

#### 2ï¸âƒ£ ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«CSVã‚’ç½®ã

`data/`ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã„å ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®CSVã‚‚è‡ªå‹•ã§æ¢ã—ã¾ã™ï¼š

```
your_project/
â”œâ”€â”€ race.csv           â† ã“ã“ã§ã‚‚OK
â”œâ”€â”€ train_lgbm_ranker_improved.py
â””â”€â”€ ...
```

---

### âš ï¸ è­¦å‘Š: jockey_profile.csvãŒè¦‹ã¤ã‹ã‚‰ãªã„

```
â„¹ï¸  jockey_profile.csv ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€é¨æ‰‹ç‰¹å¾´é‡ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™
```

**ã“ã‚Œã¯æ­£å¸¸ã§ã™ï¼**
- `jockey_profile.csv`ã¯**ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™
- ãªãã¦ã‚‚å­¦ç¿’ã¯å¯èƒ½ï¼ˆé¨æ‰‹é–¢é€£ã®ç‰¹å¾´é‡ãŒä½¿ã‚ã‚Œãªã„ã ã‘ï¼‰

**é¨æ‰‹ç‰¹å¾´é‡ã‚’ä½¿ã„ãŸã„å ´åˆï¼š**

`jockey_profile.csv`ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

```csv
jockey,jockey_front_rate,jockey_stalker_rate,jockey_closer_rate
æ­¦è±Š,0.35,0.45,0.20
å²©ç”°åº·èª ,0.25,0.50,0.25
å·ç”°å°†é›…,0.30,0.40,0.30
```

- `jockey_front_rate`: å…ˆè¡Œç‡
- `jockey_stalker_rate`: å·®ã—ç‡
- `jockey_closer_rate`: è¿½è¾¼ç‡

---

### ğŸ“Š ç²¾åº¦ãŒä½ã„ï¼ˆçš„ä¸­ç‡50%ä»¥ä¸‹ï¼‰

**ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š**

#### 1ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿é‡ã¯ååˆ†ï¼Ÿ
- **æ¨å¥¨**: 1,000ãƒ¬ãƒ¼ã‚¹ä»¥ä¸Š
- **æœ€ä½**: 500ãƒ¬ãƒ¼ã‚¹

ç¢ºèªæ–¹æ³•ï¼š
```python
import pandas as pd
df = pd.read_csv("data/your_file.csv")
print(f"ãƒ¬ãƒ¼ã‚¹æ•°: {df['race_id'].nunique()}")
```

#### 2ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ã®è³ªã¯è‰¯å¥½ï¼Ÿ
- æ¬ æå€¤ãŒå¤šã™ããªã„ã‹
- ç•°å¸¸å€¤ãŒãªã„ã‹

ç¢ºèªæ–¹æ³•ï¼š
```python
# æ¬ æå€¤ã®ç¢ºèª
print(df.isnull().sum())

# åŸºæœ¬çµ±è¨ˆ
print(df.describe())
```

#### 3ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ã¯é©åˆ‡ï¼Ÿ
- è¨“ç·´ã¨æ¤œè¨¼ãŒåŒã˜ç«¶é¦¬å ´ãƒ»æ¡ä»¶ã‹

`Config.TRAIN_END_DATE`ã‚’èª¿æ•´ï¼š
```python
TRAIN_END_DATE = "2024-08-31"  # ã‚ˆã‚Šæ–°ã—ã„æ—¥ä»˜ã«
```

#### 4ï¸âƒ£ ç‰¹å¾´é‡ã¯ååˆ†ï¼Ÿ
å‡ºåŠ›ã•ã‚Œã‚‹ç‰¹å¾´é‡é‡è¦åº¦ã‚’ç¢ºèªï¼š
```
outputs/feature_importance.csv
```

é‡è¦åº¦ã®é«˜ã„ç‰¹å¾´é‡ãŒå°‘ãªã„å ´åˆã€æ–°ã—ã„ç‰¹å¾´é‡ã‚’è¿½åŠ æ¤œè¨

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª

```python
import pandas as pd

df = pd.read_csv("data/your_file.csv")

print("="*60)
print("ãƒ‡ãƒ¼ã‚¿ã®å½¢çŠ¶:", df.shape)
print("\nã‚«ãƒ©ãƒ ä¸€è¦§:")
print(df.columns.tolist())
print("\næœ€åˆã®5è¡Œ:")
print(df.head())
print("\næ¬ æå€¤:")
print(df.isnull().sum())
```

### ã‚¹ãƒ†ãƒƒãƒ—2: å‡¦ç†ã‚’æ®µéšçš„ã«å®Ÿè¡Œ

ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦1ã¤ãšã¤ç¢ºèªï¼š

```python
# åŸºæœ¬å‰å‡¦ç†ã®ã¿
df = apply_all_features(df)
print("åŸºæœ¬å‰å‡¦ç†å¾Œ:", df.shape)

# é€šéé †ã®ã¿è¿½åŠ 
df = add_passing_features(df)
print("é€šéé †è¿½åŠ å¾Œ:", df.shape, df.columns.tolist())

# ... ä»¥ä¸‹åŒæ§˜
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ã‚°ã‚’è©³ç´°åŒ–

`train_lgbm_ranker_improved.py`ã«è¿½åŠ ï¼š

```python
import traceback

for name, func, required_cols in feature_funcs:
    try:
        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
    except Exception as e:
        print(f"   âŒ {name} ã§ã‚¨ãƒ©ãƒ¼:")
        print(f"      {e}")
        traceback.print_exc()  # â† è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
```

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã¨å…±ã«ã”ç›¸è«‡ãã ã•ã„ï¼š

1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡**
2. **ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼**ï¼ˆã‚«ãƒ©ãƒ åã¨ã‚µãƒ³ãƒ—ãƒ«5è¡Œï¼‰
3. **å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**
4. **Pythonç’°å¢ƒ**ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ï¼‰

```bash
# ç’°å¢ƒæƒ…å ±ã®å–å¾—
python --version
pip list | grep -E "pandas|numpy|lightgbm"
```
